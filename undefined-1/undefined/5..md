---
description: ê²°ì œê²°ê³¼ë¥¼ ê²€ì¦í•˜ì—¬ ì•ˆì •ì ì¸ ê²°ì œì„œë¹„ìŠ¤ êµ¬ì¶•ì— ê´€í•œ ê°€ì´ë“œ ì…ë‹ˆë‹¤.
---

# ğŸ”¦ 5. ê²°ì œì •ë³´ ê²€ì¦í•˜ê¸°

ìš´ì˜ì¤‘ì¸ ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ ë¶€í„° ì „ë‹¬ ë°›ì€ ê²°ì œ ê²°ê³¼ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ <mark style="color:red;">**ê²°ì œê¸ˆì•¡ ìœ„ë³€ì¡° ì—¬ë¶€**</mark>ë¥¼ ê²€ì¦í•˜ê³  í•„ìš”ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•©ë‹ˆë‹¤. ê²°ì œ ì •ë³´ë¥¼ ê²€ì¦í•˜ëŠ” ê³¼ì •ì€ í¬ê²Œ ì•„ë˜ì™€ ê°™ì€ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

* ì•„ì„í¬íŠ¸ ê²°ì œê³ ìœ ë²ˆí˜¸(**imp\_uid**), ì£¼ë¬¸ë²ˆí˜¸(**merchant\_uid**)ë¥¼ ì„œë²„ë‹¨ì—ì„œ ìˆ˜ì‹ 
* ê²°ì œ ìƒì„¸ë‚´ì—­ ì¡°íšŒë¥¼ ìœ„í•´ ì•„ì„í¬íŠ¸ [**ê²°ì œ ë‹¨ê±´ ì¡°íšŒ API** ](https://api.iamport.kr/#!/payments/getPaymentByImpUid)ìš”ì²­
* ì‘ë‹µë°›ì€ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ ê²°ì œ ê¸ˆì•¡ê³¼ ê²°ì œìš”ì²­ê¸ˆì•¡(ê°€ë§¹ì  ìì²´ ë°ì´í„°ë² ì´ìŠ¤)ì„ ë¹„êµ

### <mark style="color:green;">**STEP 01**</mark>  ê²°ì œê²°ê³¼ ì„œë²„ ìˆ˜ì‹ 

{% tabs %}
{% tab title="Node.js" %}
ê²°ì œì •ë³´ë¥¼ ë°›ì€ ê°€ë§¹ì  endpoint URL ì— ëŒ€í•œ POST ìš”ì²­ì„ ìˆ˜ì‹ í•˜ëŠ” ì˜ˆì œ

{% code title="server-side" %}
```javascript
app.use(bodyParser.json());
  // "{ì„œë²„ì˜ ê²°ì œ ì •ë³´ë¥¼ ë°›ëŠ” ê°€ë§¹ì  endpoint}" POST ìš”ì²­ ìˆ˜ì‹ ë¶€
  app.post("/payments/complete", async (req, res) => {
    try {
      // reqì˜ bodyì—ì„œ imp_uid, merchant_uid ì¶”ì¶œ
      const { imp_uid, merchant_uid } = req.body; 
    } catch (e) {
      res.status(400).send(e);
    }
  });
```
{% endcode %}
{% endtab %}
{% endtabs %}

### <mark style="color:green;">**STEP 02**</mark>  ê²°ì œë‚´ì—­ ë‹¨ê±´ ì¡°íšŒ

{% tabs %}
{% tab title="Node.js" %}
ìˆ˜ì‹ ë°›ì€ ì•„ì„í¬íŠ¸ **ê²°ì œê³ ìœ ë²ˆí˜¸(imp\_uid)**ë¡œ  [**ê²°ì œë‹¨ê±´ì¡°íšŒ**](https://api.iamport.kr/#!/payments/getPaymentByImpUid) **API** ë¥¼ í˜¸ì¶œí•˜ì—¬ ê²°ì œì •ë³´ íšë“ ì˜ˆì œ

{% code title="server-side" %}
```javascript
app.use(bodyParser.json());
    ...
    app.post("/payments/complete", async (req, res) => {
      try {
        // reqì˜ bodyì—ì„œ imp_uid, merchant_uid ì¶”ì¶œ
        const { imp_uid, merchant_uid } = req.body; 
        ...
        // ì•¡ì„¸ìŠ¤ í† í°(access token) ë°œê¸‰ ë°›ê¸°
        const getToken = await axios({
          url: "https://api.iamport.kr/users/getToken",
          method: "post", // POST method
          headers: { "Content-Type": "application/json" }, 
          data: {
            imp_key: "imp_apikey", // REST API í‚¤
            imp_secret: "ekKoeW8RyKuT0zgaZsUtXXTLQ4AhPFW3ZGseDA6bkA5lamv9OqDMnxyeB9wqOsuO9W3Mx9YSJ4dTqJ3f" // REST API Secret
          }
        });
        const { access_token } = getToken.data.response; // ì¸ì¦ í† í°
        ...
        // imp_uidë¡œ ì•„ì„í¬íŠ¸ ì„œë²„ì—ì„œ ê²°ì œ ì •ë³´ ì¡°íšŒ
        const getPaymentData = await axios({
          // imp_uid ì „ë‹¬
          url: \`https://api.iamport.kr/payments/\${imp_uid}\`, 
          // GET method
          method: "get", 
          // ì¸ì¦ í† í° Authorization headerì— ì¶”ê°€
          headers: { "Authorization": access_token } 
        });
        const paymentData = getPaymentData.data.response; // ì¡°íšŒí•œ ê²°ì œ ì •ë³´
        ...
      } catch (e) {
        res.status(400).send(e);
      }
    });
```
{% endcode %}
{% endtab %}
{% endtabs %}

### <mark style="color:green;">**STEP 03**</mark>  ê²°ì œì •ë³´ ê²€ì¦

> #### ê²°ì œê¸ˆì•¡ì˜ ìœ„ë³€ì¡° ê²€ì¦ ì´ìœ 
>
> ê²°ì œ ìš”ì²­ì€ í´ë¼ì´ì–¸íŠ¸ í™˜ê²½ì—ì„œ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì— **í´ë¼ì´ì–¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¡°ì‘í•´ ê¸ˆì•¡ì„ ìœ„ ë³€ì¡°í•˜ì—¬ ê²°ì œë¥¼ ìš”ì²­**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê²°ì œì™„ë£Œ í›„ ì²˜ìŒ ìš”ì²­í–ˆë˜ ê¸ˆì•¡ê³¼ ì‹¤ì œë¡œ ê²°ì œëœ ê¸ˆì•¡ì„ ë°˜ë“œì‹œ ë¹„êµí•´ì•¼ í•©ë‹ˆë‹¤.
>
> ì˜ˆë¥¼ ë“¤ì–´, 100,000ì›ì§œë¦¬ ìƒí’ˆì„ ê²°ì œí•  ë•Œì—ëŠ” `amount: 100000`ìœ¼ë¡œ ê²°ì œìš”ì²­ì„ í•˜ê²Œ ë˜ëŠ”ë°, ê³µê²©ìê°€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¡°ì‘í•˜ì—¬ í•´ë‹¹ ì†ì„±ì„ ì‹¤ì œ ê¸ˆì•¡ë³´ë‹¤ ë‚®ì€ ê°’ìœ¼ë¡œ ë³€ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&#x20;
>
> í´ë¼ì´ì–¸íŠ¸ì—ì„œì˜ ìŠ¤í¬ë¦½íŠ¸ ì¡°ì‘ì€ ì›ì²œì ìœ¼ë¡œ ë§‰ì„ ìˆ˜ ì—†ëŠ” ê¸°ìˆ ì  íŠ¹ì§•ì´ ìˆê¸° ë•Œë¬¸ì— **ê²°ì œ í›„ ì„œë²„ì—ì„œ ê²°ì œê¸ˆì•¡ì˜ ìœ„ë³€ì¡° ì—¬ë¶€ë¥¼ ë°˜ë“œì‹œ ê²€ì¦**í•´ì•¼ í•©ë‹ˆë‹¤.

{% tabs %}
{% tab title="Node.js" %}
ê²°ì œëœ ì‹¤ ê¸ˆì•¡ê³¼ ìš”ì²­ ê¸ˆì•¡ì„ ë¹„êµí•˜ì—¬ **ê²°ì œê¸ˆì•¡ ìœ„ë³€ì¡°ì—¬ë¶€ ê²€ì¦** ë° DBì €ì¥ ì˜ˆì‹œ

{% code title="server-side" %}
```javascript
app.use(bodyParser.json());
  ...
  app.post("/payments/complete", async (req, res) => {
    try {
      // reqì˜ bodyì—ì„œ imp_uid, merchant_uid ì¶”ì¶œ
      const { imp_uid, merchant_uid } = req.body; 
      // ì•¡ì„¸ìŠ¤ í† í°(access token) ë°œê¸‰ ë°›ê¸°
      /* ...ì¤‘ëµ... */
      // imp_uidë¡œ ì•„ì„í¬íŠ¸ ì„œë²„ì—ì„œ ê²°ì œ ì •ë³´ ì¡°íšŒ
      /* ...ì¤‘ëµ... */
      const paymentData = getPaymentData.data.response; // ì¡°íšŒí•œ ê²°ì œ ì •ë³´
      ...
      // DBì—ì„œ ê²°ì œë˜ì–´ì•¼ í•˜ëŠ” ê¸ˆì•¡ ì¡°íšŒ
      const order = await Orders.findById(paymentData.merchant_uid);
      const amountToBePaid = order.amount; // ê²°ì œ ë˜ì–´ì•¼ í•˜ëŠ” ê¸ˆì•¡
      ...
      // ê²°ì œ ê²€ì¦í•˜ê¸°
      const { amount, status } = paymentData;
      // ê²°ì œê¸ˆì•¡ ì¼ì¹˜. ê²°ì œ ëœ ê¸ˆì•¡ === ê²°ì œ ë˜ì–´ì•¼ í•˜ëŠ” ê¸ˆì•¡
      if (amount === amountToBePaid) { 
        await Orders.findByIdAndUpdate(merchant_uid, { $set: paymentData }); // DBì— ê²°ì œ ì •ë³´ ì €ì¥
        ...
        switch (status) {
          case "ready": // ê°€ìƒê³„ì¢Œ ë°œê¸‰
            // DBì— ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì •ë³´ ì €ì¥
            const { vbank_num, vbank_date, vbank_name } = paymentData;
            await Users.findByIdAndUpdate("/* ê³ ê° id */", { $set: { vbank_num, vbank_date, vbank_name }});
            // ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì•ˆë‚´ ë¬¸ìë©”ì‹œì§€ ë°œì†¡
            SMS.send({ text: \`ê°€ìƒê³„ì¢Œ ë°œê¸‰ì´ ì„±ê³µë˜ì—ˆìŠµë‹ˆë‹¤. ê³„ì¢Œ ì •ë³´ \${vbank_num} \${vbank_date} \${vbank_name}\`});
            res.send({ status: "vbankIssued", message: "ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì„±ê³µ" });
            break;
          case "paid": // ê²°ì œ ì™„ë£Œ
            res.send({ status: "success", message: "ì¼ë°˜ ê²°ì œ ì„±ê³µ" });
            break;
        }
      } else { // ê²°ì œê¸ˆì•¡ ë¶ˆì¼ì¹˜. ìœ„/ë³€ì¡° ëœ ê²°ì œ
        throw { status: "forgery", message: "ìœ„ì¡°ëœ ê²°ì œì‹œë„" };
      }
    } catch (e) {
      res.status(400).send(e);
    }
  });
```
{% endcode %}
{% endtab %}
{% endtabs %}

ì²˜ìŒ ìš”ì²­í•œ ê¸ˆì•¡ì€ **`merchant_uid`** ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒí•˜ê³  ì‹¤ì œ ê²°ì œê¸ˆì•¡ì€ **`imp_uid`**ë¡œ ì•„ì„í¬íŠ¸ ì„œë²„ì—ì„œ ì¡°íšŒí•˜ì—¬ ë‘ ê°’ì„ ë¹„êµí•©ë‹ˆë‹¤. ê²€ì¦ì´ ì„±ê³µí•˜ë©´ ê²°ì œ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•œ ë’¤ ê²°ì œ ìƒíƒœ(**`status`**)ì— ë”°ë¼ ì•Œë§ì€ ì‘ë‹µì„ ë°˜í™˜í•˜ê³  ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ê²°ì œê²°ê³¼ DB ì²˜ë¦¬ëŠ” **ì›¹í›…(Webhook)**ì„ ì—°ë™í•˜ì—¬ ìˆ˜ì‹ ë˜ëŠ” ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬í•˜ì…”ì•¼ ê²°ì œê²°ê³¼ ëˆ„ë½ì—†ì´ ì•ˆì •ì ì¸ ê²°ê³¼ì²˜ë¦¬ë¥¼ ì™„ë£Œí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}
